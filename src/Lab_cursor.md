---
title: Лабораторная работа. Курсоры
---

[Вариант 2](assets/lab/v2.md)

[Таблица учеников](assets/lab5/Students.xlsx)

[К списку лабораторных >>>](../README.md)

---

### Задания по таблице учеников (курсоры)

1. Создайте курсор, содержащий отсортированные по баллам фамилии и баллы учеников, откройте его, выведите первую строку, закройте и освободите курсор.
2. Создайте курсор с прокруткой, содержащий список учеников, откройте его, выведите пятую, предыдущую, с конца четвертую, следующую, первую строку, закройте и освободите курсор.
3. Создайте курсор с прокруткой, содержащий список учеников, откройте его, выведите последнюю, шесть позиций назад находящуюся, четыре позиций вперед находящуюся строку, закройте и освободите курсор.
4. С помощью курсора, вычислите сумму баллов у учеников с наибольшим и наименьшим баллом.
5. С помощью курсора, сгенерируйте строку вида «Ученики <список фамилий и названий предметов, разделенных запятыми> участвовали в олимпиаде».
6. Создайте курсор, содержащий список учеников, с его помощью выведите учеников с нечетной позицией.
7. Создайте курсор, содержащий отсортированный по убыванию баллов список учеников, откройте его, для каждого ученика выведите фамилию, предмет, школу, баллы и процентное соотношение баллов с предыдущим учеником.

---   

### Курсоры

Инструкции Transact-SQL выполняют операции над множествами, но интерактивным приложениям иногда требуется обрабатывать результаты построчно. 

Для выполнения команд над отдельной строкой предусмотрены курсоры. 
Открытие курсора в результирующем наборе делает возможной его построчную обработку. 
Можно присвоить курсор переменной или параметру с типом данных CURSOR.

Курсоры позволяют усовершенствовать обработку результатов: 

* позиционируясь на отдельные строки результирующего набора;
* получая одну или несколько строк от текущей позиции в результирующем наборе;
* поддерживая изменение данных в строках в текущей позиции результирующего набора;
* поддерживая разные уровни видимости изменений, сделанных другими пользователями для данных, представленных в результирующем наборе;
* предоставляя инструкциям Transact-SQL в скриптах, хранимых процедурах и триггерах доступ к данным результирующего набора.
  
---

### Создание курсоров

Обычно курсоры используются для выбора из базы данных некоторого подмножества хранимой в ней информации. 

В каждый момент времени прикладной программой может быть проверена одна строка курсора. 
Курсоры часто применяются в операторах SQL, встроенных в написанные на языках процедурного типа прикладные программы.
Некоторые из них неявно создаются сервером базы данных, в то время как другие определяются программистами.

В соответствии со стандартом SQL при работе с курсорами можно выделить следующие основные действия: 

* создание или объявление курсора;
* открытие курсора, т.е. наполнение его данными, которые сохраняются в многоуровневой памяти;
* выборка из курсора и изменение с его помощью строк данных;
* закрытие курсора, после чего он становится недоступным для пользовательских программ;
* освобождение курсора, т.е. удаление курсора как объекта, поскольку его закрытие необязательно освобождает ассоциированную с ним память.
  
После освобождения курсора ассоциированная с ним память также освобождается.
При этом становится возможным повторное использование его имени.
В некоторых случаях применение курсора неизбежно. 
Однако по возможности этого следует избегать и работать со стандартными командами обработки данных: 
SELECT, UPDATE, INSERT, DELETE. 
Помимо того, что курсоры не позволяют проводить операции изменения над всем объемом данных, 
скорость выполнения операций обработки данных посредством курсора заметно ниже, чем у стандартных средств Transact-SQL.

SQL Server поддерживает четыре типа курсоров:

* Однонаправленный курсор – указывается как FORWARD_ONLY и не поддерживает прокрутку.
  Он также называется курсором FIREHOSE и поддерживает только получение строк последовательно, от начала до конца курсора.
  Строки нельзя получить из базы данных, пока они не будут выбраны.
  Результаты всех инструкций INSERT, UPDATE и DELETE, влияющих на строки результирующего набора
  (выполненных текущим пользователем или зафиксированных другими пользователями), отображаются как строки, выбранные из курсора.
  
* Статический курсор – полный результирующий набор статического курсора создается в базе данных TEMPDB при открытии курсора.
  Статический курсор всегда отображает результирующий набор точно в том виде, в котором он был при открытии курсора.
  Статическими курсорами обнаруживаются лишь некоторые изменения или не обнаруживаются вовсе,
  но при этом в процессе прокрутки такие курсоры потребляют сравнительно мало ресурсов.
  Статические курсоры всегда доступны только для чтения.

* KEYSET курсор – членство и порядок строк в курсоре, управляемом набором ключей,
  являются фиксированными при открытии курсора.
  Такие курсоры управляются с помощью набора уникальных идентификаторов – ключей.
  Ключи создаются из набора столбцов, который уникально идентифицирует строки результирующего набора.

* Динамический курсор – это противоположность статических курсоров.
  Динамические курсоры отражают все изменения строк в результирующем наборе при прокрутке курсора.
  Значения типа данных, порядок и членство строк в результирующем наборе могут меняться для каждой выборки.
  Все инструкции UPDATE, INSERT и DELETE, выполняемые пользователями, видимы посредством курсора.

Упрощенный шаблон использования курсора имеет следующий синтаксис:

```sql
DECLARE <имя_курсора> CURSOR [FORWARD_ONLY | SCROLL]
FOR <SELECT_оператор>
OPEN <имя_курсора>
FETCH <NEXT|PRIOR|FIRST|LAST|ABSOLUTE <число>| RELATIVE <число>> FROM <имя_курсора> INTO <@переменная>
CLOSE <имя_курсора>
DEALLOCATE <имя_курсора>
```

Инструкция DEALLOCATE удаляет связь между курсором и переменной, и освобождает структуры данных, составляющие курсор.

Пример: Создайте курсор с прокруткой, содержащий список учеников, откройте его, 
выведите пятую, предыдущую, с конца четвертую, шесть позиций назад находящуюся,
четыре позиций вперед находящуюся, следующую, первую, последнюю строку, закройте и освободите курсор:
```sql
DECLARE MyCursor CURSOR SCROLL
FOR
SELECT
ID, Фамилия, Предмет, Школа, Баллы
FROM Ученики
OPEN MyCursor
FETCH ABSOLUTE 5 FROM MyCursor
FETCH PRIOR FROM MyCursor
FETCH ABSOLUTE -4 FROM MyCursor
FETCH RELATIVE -6 FROM MyCursor
FETCH RELATIVE 4 FROM MyCursor
FETCH NEXT FROM MyCursor
FETCH FIRST FROM MyCursor
FETCH LAST FROM MyCursor
CLOSE MyCursor
DEALLOCATE MyCursor
```

---

### Прокрутка и ключевые слова для курсоров

#### OPEN

После создания курсора, чтобы его использовать, надо открыть курсор с помощью команды OPEN. 

#### CLOSE

А команда CLOSE закрывает открытый курсор, высвобождая текущий результирующий набор и снимая блокировки курсоров для строк.
Для получения определенной строки используется команда FETCH.

#### NEXT

Ключевое слово NEXT возвращает следующую строку и перемещает указатель текущей строки на возвращенную строку. 
Если инструкция FETCH NEXT выполняет первую выборку в отношении курсора, она возвращает первую строку в результирующем наборе. 
NEXT является параметром по умолчанию выборки из курсора.

#### PRIOR

Ключевое слово PRIOR возвращает предыдущую строку и перемещает указатель текущей строки на возвращенную строку. 
Если инструкция FETCH PRIOR выполняет первую выборку из курсора, не возвращается никакая строка и положение курсора остается перед первой строкой.

#### FIRST

Ключевое слово FIRST возвращает первую строку в курсоре и делает ее текущей.

#### LAST

Ключевое слово LAST возвращает последнюю строку в курсоре, делая ее текущей.

#### ABSOLUTE

Ключевое слово ABSOLUTE с аргументом – положительным целым числом, 
возвращает строку с указанным номером от начала курсора, и делает ее текущей строкой. 
Если число отрицательное, возвращает строку с указанным номером от конца курсора, делая ее текущей строкой.

#### RELATIVE

Ключевое слово RELATIVE с аргументом – положительным целым числом возвращает строку 
с указанным номером после текущей строки и делает ее текущей строкой. 
Если число отрицательное, возвращает строку с указанным номером до текущей строки и делает ее текущей строкой.
Если число равно 0, возвращает текущую строку.

#### INTO

Ключевое слово INTO позволяет поместить данные из столбцов выборки в локальные переменные. 
Каждая переменная из списка, слева направо, связывается с соответствующим столбцом в результирующем наборе курсора. 
Типы данных переменных должны соответствовать типам данных соответствующего столбца результирующего набора.
Количество переменных и столбцов тоже должны совпадать.

---

### Использование циклов в курсорах

Для обработки результирующего набора построчно можно использовать инструкцию FETCH NEXT в цикле WHILE. 
Как условие в цикле используется функция @@FETCH_STATUS, 
которая возвращает состояние последней инструкции FETCH, вызванной в любом курсоре, открытом в рамках этого подключения.

Функция @@FETCH_STATUS возвращает одно из четырех значений:
0 Инструкция FETCH была выполнена успешно.
-1 Выполнение инструкции FETCH завершилось неудачно или строка оказалась вне пределов результирующего набора.
-2 Выбранная строка отсутствует.
-9 Курсор не выполняет операцию выборки.

Упрощенный синтаксис использования функции @@FETCH_STATUS имеет следующий вид:
  
```sql
FETCH NEXT FROM <имя_курсора>
WHILE @@FETCH_STATUS = 0
BEGIN
FETCH NEXT FROM <имя_курсора>
END
```

Пример: 
С помощью курсора сгенерируйте строку вида «Ученики <список фамилий и названий школ, разделенных запятыми> участвовали в олимпиаде»:

```sql
DECLARE MyCursor CURSOR SCROLL
FOR
SELECT Фамилия, Школа
FROM Ученики
DECLARE @S VARCHAR(2000), @F VARCHAR(50), @W VARCHAR(50)
OPEN MyCursor
SET @S = 'Ученики'
FETCH NEXT FROM MyCursor INTO @F, @W
WHILE @@FETCH_STATUS = 0
BEGIN
SET @S = @S + ', ' + @F + ' из школы "' + @W + '"'
FETCH NEXT FROM MyCursor INTO @F, @W
END
SET @S = @S + ' участвовали на олимпиаде.'
PRINT @S
CLOSE MyCursor
DEALLOCATE MyCursor
```

Пример: Создайте курсор, содержащий список учеников, с его помощью выведите учеников с четной позицией:
```sql
DECLARE MyCursor CURSOR SCROLL
FOR
SELECT
ID, Фамилия, Предмет, Школа, Баллы
FROM Ученики
OPEN MyCursor
FETCH ABSOLUTE 2 FROM MyCursor
WHILE @@FETCH_STATUS = 0
BEGIN
FETCH RELATIVE 2 FROM MyCursor
END
CLOSE MyCursor
DEALLOCATE MyCursor
```

---

### Использование переменных в курсорах

Пример: С помощью курсора вычислите среднее арифметическое значение балла у учеников с наибольшим и наименьшим баллом:
```sql
DECLARE MyCursor CURSOR SCROLL
FOR
SELECT Баллы
FROM Ученики
ORDER BY Баллы
DECLARE @S FLOAT = 0, @B FLOAT
OPEN MyCursor
FETCH FIRST FROM MyCursor INTO @B
SET @S = @S + @B
FETCH LAST FROM MyCursor INTO @B
SET @S = @S + @B
SET @S = @S / 2
PRINT @S
CLOSE MyCursor
DEALLOCATE MyCursor
```
