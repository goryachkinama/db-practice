---
title: Лабораторная работа. Оконные функции
---

[Вариант 2](assets/lab/v2.md)

[Таблица учеников](assets/lab5/Students.xlsx)

[К списку лабораторных >>>](../README.md)

---

### Задания по таблице учеников (оконные функции)

1. Вывести список учеников и разницу между баллами ученика и максимальным баллом в каждой строке.
2. Вывести список учеников и процентное соотношение к среднему баллу в каждой строке.
3. Вывести список учеников и минимальный балл в школе в каждой строке.
4. Вывести список учеников и суммарный балл в школе в каждой строке, отсортировать по школам в оконной функции.
5. Вывести список учеников и номер строки при сортировке по фамилиям в обратном алфавитном порядке.
6. Вывести список учеников, номер строки внутри школы и количество учеников в школе при сортировке по баллам по убыванию.
7. Вывести список учеников и ранг по баллам.
8. Вывести список учеников и сжатый ранг по баллам. Результат отсортировать по фамилии в алфавитном порядке.
9. Вывести список учеников, распределенных по пяти группам по фамилии.
10. Вывести список учеников, распределенных по трем группам по баллам внутри школы.
11. Вывести список учеников и разницу с баллами ученика, находящегося выше на три позиции при сортировке по возрастанию баллов.
12. Вывести список учеников и разницу с баллами следующего ученика при сортировке по убыванию баллов, значение по умолчанию использовать 0.
    
---

### Оконные функции

Оконные функции используются для вычисления в заданной секции. 
Оконные функции не приводят к группированию строк в одну строку вывода, 
строки сохраняют свои отдельные идентификаторы, а агрегированное значение добавляется к каждой строке.

Для определения секций используется инструкция OVER. 

Упрощенный синтаксис имеет следующий вид:

```sql
<функция> <столбец для вычислений> OVER ([PARTITION BY <столбец для группировки>] [ORDER BY <столбец для сортировки>])
```

Предложение PARTITION BY разделяет результирующий набор запроса на секции. 
Оконная функция применяется к каждой секции отдельно, и вычисление начинается заново для каждой секции.

Предложение ORDER BY определяет сортировку строк в каждой секции результирующего набора.

Оконные функции разделяются на агрегирующие, ранжирующие и функции смещения.

--

### Агрегирующие функции

Агрегирующие функции MAX(), MIN(), SUM, AVG(), COUNT() можно применить к секциям результирующего набора запроса. 

Синтаксис функций имеет следующий вид:

```sql
MAX|MIN|SUM|AVG|COUNT(<столбец>) OVER([PARTITION BY <столбцы>] [ORDER BY <столбцы>])
```

В агрегирующих функциях предложение PARTITION BY можно не указывать, 
тогда функция обрабатывает все строки результирующего набора запроса как одну группу. 
Предложение ORDER BY определяет последовательность, в которой строкам назначаются уникальные номера.
Его также можно не указать.

Пример 5: Вывести список учеников и количество учеников в школе в каждой строке, отсортировать по школам в оконной функции:
```sql
SELECT Фамилия, Предмет, Школа, Баллы
,COUNT(*) OVER(PARTITION BY Школа ORDER BY Школа) AS Кол_Шк
FROM Ученики
```

--

### Ранжирующие функции

Ранжирующие функции возвращают ранжирующее значение для каждой строки в секции и являются недетерминированными.
В ранжирующих функциях предложение PARTITION BY можно не указывать, 
тогда функция обрабатывает все строки результирующего набора запроса как одну группу. 
Предложение ORDER BY определяет последовательность, в которой строкам назначаются уникальные номера. 
Оно должно указываться обязательно.

Transact-SQL содержит следующие ранжирующие функции:

#### ROW_NUMBER

ROW_NUMBER – нумерует выходные данные результирующего набора, то есть, 
возвращает последовательный номер строки, начиная с 1, в секции результирующего набора. 

Синтаксис функции имеет следующий вид:
```sql
ROW_NUMBER( ) OVER([PARTITION BY <столбцы>] ORDER BY <столбцы>)
```

Пример 6: Вывести список учеников и номер строки при сортировке по баллам по убыванию:
```sql
SELECT
ROW_NUMBER() OVER(ORDER BY Баллы DESC) AS Номер_строки
,Фамилия, Предмет, Школа, Баллы
FROM Ученики
```

#### RANK

RANK – возвращает ранг каждой строки в секции результирующего набора. 

Ранг строки вычисляется как единица плюс количество рангов, находящихся до этой строки. 
В отличии от функции ROW_NUMBER, RANK назначает одинаковое значение строкам, претендующим на один ранг. 

Синтаксис функции имеет следующий вид:
```sql
RANK( ) OVER([PARTITION BY <столбцы>] ORDER BY <столбцы>)
```

#### DENSE_RANK

DENSE_RANK – возвращает ранг каждой строки в секции результирующего набора без промежутков в значениях ранжирования. 
Ранг определенной строки равен количеству различных значений рангов, предшествующих строке, увеличенному на единицу. 

Синтаксис функции имеет следующий вид:
```sql
DENSE_RANK( ) OVER([PARTITION BY <столбцы>] ORDER BY <столбцы>)
```

Пример: Вывести список учеников и сжатый ранг по баллам в каждой школе. 
Результат отсортировать по фамилии в алфавитном порядке:
```sql
SELECT
DENSE_RANK() OVER(PARTITION BY Школа ORDER BY Баллы DESC) AS Сж_Ранг_Шк
,Фамилия, Предмет, Школа, Баллы
FROM Ученики
ORDER BY Фамилия
```

#### NTILE

NTILE – распределяет строки упорядоченной секции в заданное количество групп. 
Группы нумеруются, начиная с единицы. Для каждой строки функция NTILE возвращает номер группы, которой принадлежит строка. 

Синтаксис функции имеет следующий вид:
```sql
NTILE(<количество групп>) OVER([PARTITION BY <столбцы>] ORDER BY <столбцы>)
```

Пример: Вывести список учеников, распределенных по двум группам по баллам внутри школы:
```sql
SELECT
NTILE(2) OVER(PARTITION BY Школа ORDER BY Баллы DESC) AS Гр_Балл
,Фамилия, Предмет, Школа, Баллы
FROM Ученики
```

---

### Функции смещения

Функции смещения возвращают значение из другой строки секции результирующего набора запроса. 
Предложение ORDER BY должно указываться обязательно.
Transact-SQL содержит следующие функции смещения:
Функции LAG() и LEAD() – обращаются к данным из предыдущей или последующей строки того же результирующего набора. 

Синтаксис функций имеет следующий вид:
```sql
LAG|LEAD(<столбец> [,<смещение>] [,<значение по умолчанию>]) OVER([PARTI-TION BY <столбцы>] ORDER BY <столбцы>)
```

Пример: Вывести список учеников и разницу с баллами ученика через две позиции при сортировке по убыванию баллов, значение по умолчанию использовать 0:
```sql
SELECT Фамилия, Предмет, Школа, Баллы
,Баллы - LEAD(Баллы, 2, 0) OVER(ORDER BY Баллы DESC) AS Разница
FROM Ученики
```

Параметр «смещение» указывает количество строк до строки перед или после текущей строки, из которой необходимо получить значение.

Если значение аргумента не указано, то по умолчанию принимается 1.
«Значение по умолчанию» должно иметь такой же тип данных, как первый параметр, используется, когда «смещение» находится за пределами секции. 
Если не задано, то возвращается NULL.
Функции FIRST_VALUE() и LAST_VALUE() – возвращают первое или последнее значение из упорядоченного набора значений.

Синтаксис функций имеет следующий вид:
```sql
FIRST_VALUE|LAST_VALUE(<столбец>) OVER([PARTITION BY <столбцы>] OR-DER BY <столбцы>)
```

---

### Примеры



Пример: Вывести список учеников и разницу с баллами последнего ученика в школе при сортировке по убыванию баллов:

```sql
SELECT Фамилия, Предмет, Школа, Баллы
,LAST_VALUE(Баллы) OVER(ORDER BY Баллы RANGE BETWEEN UN-BOUNDED PRECEDING AND UNBOUNDED FOLLOWING) - Баллы AS Разница
FROM
Ученики
```

---
