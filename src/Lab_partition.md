---
Оптимизация работы с большим объемом данных при помощи партиционирования в SQL: Лабораторная работа
---

[К списку лабораторных >>>](../README.md)

---

### Задания

1. Создать таблицу с разделением на партиции
2. Распределить данные по созданным партициям
3. Создать локальные индексы создаются на отдельной партиции
4. Создать глобальные индексы на всю таблицу
5. Использование управляемых запросов в партициях

---

### [Оптимизация работы с большим объемом данных при помощи партиционирования в T-SQL](https://habr.com/ru/companies/otus/articles/745872/)

Работа с большим объемом данных является неотъемлемой частью профессиональной разработки. 
Независимо от того, занимаетесь ли вы разработкой веб-приложений, 
аналитикой данных или созданием сложных систем управления, 
эффективная обработка больших объемов данных – это фундамент успеха вашего проекта.

Как разработчики, мы часто сталкиваемся с задачами,
в которых требуется обрабатывать и анализировать огромные объемы данных.
Наша задача – сделать это эффективно и быстро.

Оптимизация работы с данными позволяет нам снизить временные затраты, 
улучшить производительность и повысить доступность нашего приложения. 
Быстрая и надежная обработка данных также улучшает качество принимаемых решений 
и способствует успешным бизнес-операциям. 
Поэтому важно научиться эффективно работать с большими объемами данных
и использовать подходы, которые позволят нам извлекать максимальную выгоду из наших ресурсов.

Одним из эффективных методов оптимизации работы с большим объемом данных является партиционирование. 

Партиционирование – это разделение таблицы на отдельные части (партиции)
с целью улучшить производительность выполнения SQL запросов.

Партиционирование позволяет нам разделить данные на более управляемые части, 
улучшая их доступность и обработку. Каждая партиция может быть независимо обработана, 
что упрощает и ускоряет выполнение запросов. Это особенно полезно для таблиц 
с большим числом записей или для таблиц, которые часто обновляются или анализируются.

Результаты партиционирования могут быть поразительными: 
* время выполнения запросов снижается, 
* возможность параллельной обработки данных повышается, 
* архитектура базы данных оказывается более устойчивой к изменениям. 

Весь этот комплекс преимуществ делает партиционирование
незаменимым инструментом для оптимизации работы с большим объемом данных.

### Партиционирование в SQL

#### Определение понятия партиционирования

Партиционирование является одним из важных аспектов проектирования баз данных в SQL. 
Это техника, которая позволяет разбить таблицу на несколько физических или логических разделов.
Каждая такая разделенная часть называется партицией. 
Партиционирование применяется с целью улучшения производительности и эффективности работы с базой данных.

#### Как работает партиционирование в SQL

В SQL партиционирование может быть реализовано при помощи различных механизмов.
В основе всех этих механизмов лежит принцип разделения таблицы на физические 
или логические единицы хранения данных. Разделение может основываться на различных критериях,
таких как диапазон значений столбца, хеш-значение, список значений и т. д.

Последующие операции с данными, такие как выборка, вставка, обновление и удаление,
выполняются над каждой партицией независимо друг от друга.
Таким образом, параллельная обработка данных может быть реализована, 
что положительно сказывается на производительности запросов.

#### Варианты партиционирования: горизонтальное и вертикальное

Существует два основных варианта партиционирования в SQL — горизонтальное и вертикальное.

Горизонтальное партиционирование предполагает разделение таблицы на партиции, 
основанное на строках. Каждая партиция содержит определенное количество строк.
Такой подход используется, когда таблица имеет очень большой объем данных и необходима более эффективная обработка.

Вертикальное партиционирование, в свою очередь, разделяет таблицу на партиции,
основываясь на столбцах. Каждая партиция содержит определенный набор столбцов.
Такой подход может быть полезным, когда таблица имеет много столбцов и только некоторые из них часто используются.
Простейший пример - запись содержит сотню полей, 90 из которых нужны лишь раз в год,
а остальные запрашиваются чуть ли не ежесекундно.
К нему прибегают когда СУБД накладывает ограничение на кол-во полей в таблице.

Выбор того, какой тип партиционирования использовать, зависит от конкретных требований
и характеристик базы данных и ее использования. При правильном применении, 
партиционирование может значительно улучшить производительность работы с SQL-базами данных.

### Шаги по реализации партиционирования

Переходя к реализации партиционирования, мы должны следовать нескольким ключевым шагам.

#### 1. Планирование структуры партиций

Первым шагом является планирование структуры партиций.
Необходимо определить, какие колонки будут использоваться для разделения данных на партиции.
Хорошей практикой является выбор колонки с высокой селективностью,
чтобы данные равномерно распределялись по партициям.

Для примера, предположим, что у нас есть таблица событий, содержащая дату события. 
Мы можем использовать эту колонку для разделения данных на партиции по годам или месяцам.

#### 2. Создание партиций и индексов

После определения структуры партиций, 
следующим шагом является создание самих партиций и соответствующих индексов.
В SQL, это можно сделать с помощью оператора CREATE TABLE с опцией PARTITION BY.

Ниже приведен пример создания таблицы events с разделением по годам:

 ```sql
CREATE TABLE events (
    event_id INT,
    event_date DATE,
    event_name VARCHAR(100)
)
PARTITION BY RANGE (YEAR(event_date)) (
    PARTITION p2019 VALUES LESS THAN (2020),
    PARTITION p2020 VALUES LESS THAN (2021),
    PARTITION p2021 VALUES LESS THAN (2022)
);
```

Надо помнить, что в партицированную таблицу можно добавлять партиции руками 
(а вот непартицированную сделать партицированной не получится, надо будет таблицу пересоздавать)

#### 3. Методы распределения данных по партициям

Следующий шаг — распределение данных по созданным партициям. 
В зависимости от требований и характеристик данных, различные методы могут использоваться для этого.

Например, для распределения данных в партиции p2019 между январем и декабрем,
мы можем использовать оператор INSERT с использованием соответствующего условия:

 ```sql
INSERT INTO events(event_id, event_date, event_name)
VALUES(1, '2019-01-01', 'Event 1'),
      (2, '2019-05-23', 'Event 2'),
      (3, '2019-12-31', 'Event 3')
WHERE YEAR(event_date) = 2019;
 ```

#### 4. Обновление статистики и проведение оптимизаций запросов

Последний шаг — обновление статистики и проведение оптимизаций запросов.
При партиционировании важно обновлять статистику о данных в партициях, 
чтобы оптимизатор запросов мог правильно выбирать путь выполнения запроса.

Оптимизация запросов для работы с партиционированными таблицами

Использование условий партиционирования для фильтрации данных

При использовании партиционированных таблиц, важно уметь правильно использовать
условия партиционирования для фильтрации данных. 
Это позволит базе данных применить фильтр только к тем партициям, 
которые содержат необходимые данные, и тем самым значительно сократить объем данных,
обрабатываемых запросом. Такой подход позволяет существенно повысить производительность запросов.

Например, у нас есть партиционированная таблица «orders» с полем «order_date».
Мы хотим получить все заказы за определенный период времени.
Вместо того, чтобы фильтровать все записи таблицы,
мы можем использовать условие партиционирования и указать диапазон дат,
в котором нас интересуют заказы. Тогда база данных выполнит запрос только для партиций, 
содержащих соответствующие заказы, и избежит обработки ненужных данных.

Пример SQL-кода:
 ```sql
   SELECT *
   FROM orders
   WHERE order_date BETWEEN '2021-01-01' AND '2021-12-31';
 ```

### Использование локальных и глобальных индексов для улучшения производительности

Для оптимизации запросов с использованием партиций,
также важно правильно выбирать и использовать индексы. 
Существуют два основных типа индексов — локальные и глобальные.

Локальные индексы создаются на отдельной партиции и применяются только к этой партиции. 
Они эффективны для запросов, которые фильтруют данные по условиям, применяемым к конкретным партициям.
Например, в таблице «orders» с партиционированием по полю «order_date», 
мы можем создать локальный индекс на каждой партиции для улучшения производительности запросов, фильтрующих заказы по дате.

Глобальные индексы создаются на всей таблице и применяются ко всем партициям. 
Они эффективны для запросов, которые фильтруют данные по условиям, применяемым ко всей таблице.
Например, если у нас есть таблица «orders» с партиционированием по полю «order_status», 
мы можем создать глобальный индекс для улучшения производительности запросов, фильтрующих заказы по статусу.

Пример SQL-кода:
 ```sql
   CREATE INDEX local_index ON orders(order_date) LOCAL;
   CREATE INDEX global_index ON orders(order_status) GLOBAL;
 ```

### Оптимизация запросов с использованием партиций

Помимо использования условий партиционирования и правильного выбора индексов,
существуют и другие методы оптимизации запросов с использованием партиций.

Один из таких методов — использование управляемых партиций. 
Это возможность автоматического рассчета границ партиций на основе определенных правил. 
Например, мы можем настроить таблицу «orders» с партиционированием 
по полю «order_date» таким образом, чтобы автоматически создавались новые партиции каждый месяц.

Еще один метод оптимизации — использование merge-операторов. 
Они позволяют выполнять запросы с партициями в таком виде,
как будто это обычная непартиционированная таблица. 
База данных сама будет распределять запросы по различным партициям и собирать результаты воедино.

Пример SQL-кода:
 ```sql
   ALTER TABLE orders ADD PARTITION BY RANGE(order_date) (
   PARTITION p1 VALUES LESS THAN ('2021-01-01'),
   PARTITION p2 VALUES LESS THAN ('2021-02-01'),
   PARTITION p3 VALUES LESS THAN ('2021-03-01')
   );

   SELECT *
   FROM orders PARTITION (p1, p3)
   WHERE ...
 ```

### Заключение

К основным преимуществам партиционирования можно отнести возможность выполнять 
операции над отдельными партициями без необходимости сканировать всю таблицу,
ускорение выполнения сложных запросов благодаря снижению объема данных, 
облегчение процесса управления данными и повышение отказоустойчивости системы.

Однако необходимо принимать во внимание некоторые недостатки партиционирования,
такие как увеличение сложности самого процесса разработки и управления базами данных, 
возможность возникновения проблем с удалением или изменением партиций или с поддержкой внешних ключей.

В заключение, стоит отметить, что при правильном использовании партиционирования
в SQL можно достичь существенного повышения производительности
и оптимизации работы с большим объемом данных. 
Однако перед применением этого подхода необходимо внимательно изучить 
специфику проекта и оценить все его преимущества и возможные недостатки.

---

### Еще

[Колоночное и строчное хранение](https://bigdataschool.ru/blog/columnar-and-row-based-databases.html)

[Файлы и файловые группы](https://infostart.ru/1c/articles/709159/)
