---
Пользовательские функции: Лабораторная работа
---

[Таблица стран](assets/lab3/Страны.xlsx)

[Таблицы студентов](assets/lab6/Students.xlsx)

[К списку лабораторных >>>](../README.md)

---

### Часть 1. Задание по пользовательским функциям по таблице стран

1. Напишите функцию для вывода названия страны с заданной столицей, и вызовите ее.
2. Напишите функцию для перевода населения в млн. чел. и вызовите ее.
3. Напишите функцию для вычисления плотности населения заданной части света и вызовите ее.
4. Напишите функцию для поиска страны, третьей по населению и вызовите ее.
5. Напишите функцию для поиска страны с максимальным населением в заданной части света и вызовите ее. Если часть света не указана, выбрать Азию.
6. Напишите функцию для замены букв в заданном слове от третьей до предпоследней на “тест” и примените ее для столицы страны.
7. Напишите функцию, которая возвращает количество стран, не содержащих в названии заданную букву.
8. Напишите функцию для возврата списка стран с площадью меньше заданного числа и вызовите ее.
9. Напишите функцию для возврата списка стран с населением в интервале заданных значений и вызовите ее.
10. Напишите функцию для возврата таблицы с названием континента и суммарным населением и вызовите ее.
11. Напишите код для удаления созданных вами функций.

---

### Часть 2. Задания не по таблицам

1. Создайте табличную переменную, содержащую три столбца («Номер месяца», «Название месяца», «Количество дней»), заполните ее для текущего года, и используйте ее.
2. Напишите функцию IsPalindrom(P) целого типа, возвращающую 1, если целый параметр P (P > 0) является палиндромом, и 0 в противном случае.
3. Напишите функцию Quarter(x, y) целого типа, определяющую номер координатной четверти, содержащей точку с ненулевыми вещественными координатами (x, y).
4. Напишите функцию IsPrime(N) целого типа, возвращающую 1, если целый параметр N (N > 1) является простым числом, и 0 в противном случае.
5. Напишите команды для удаления всех созданных вами представлений и функций.

---

### Пользовательские функции

На языке Transact-SQL очень много встроенных функций. 
Несмотря на этот факт, иногда требуются функции, которых нет в стандартной библиотеке.
Transact-SQL предоставляет возможность создать собственную функцию для решения задач.

#### Скалярные функции

Пользовательская скалярная функция возвращает в качестве ответа единственное значение.

Пользовательскую функцию можно использовать следующими способами:

* В инструкциях Transact-SQL, например, SELECT.
* В приложениях, вызывающих функцию.
* В определении другой пользовательской функции.
* Для определения столбца таблицы.
* Для определения ограничения CHECK на столбец.

Пользовательские функции не могут выполнять действия, изменяющие состояние базы данных.
Пользовательские функции не могут возвращать несколько результирующих наборов.
Пользовательские функции не могут использовать динамический SQL и временные таблицы.

Табличные переменные разрешены к использованию.

Пользовательские функции могут быть вложенными, то есть из одной функции может быть вызвана другая.
Вложенность функций не может превышать 32 уровней.

Упрощенный синтаксис создания пользовательской скалярной функции имеет следующий вид:

```sql
CREATE FUNCTION <название>
(
[{<@параметр> [AS] <тип> [= <значение по умолчанию>]}]
)
RETURNS <тип возврата>
[AS]
BEGIN
<команды>
RETURN <значение>
END
```
Значение, переменная или выражение после ключевого слова RETURN имеет такой же тип, 
который указан после ключевого слова RETURNS.

Если функция не предполагает передачу параметров, то в скобках ничего не укзаывается:
```sql
CREATE FUNCTION <название>()
RETURNS <тип возврата>
[AS]
<тело функции>
```

#### Функции INLINE

Для INLINE функций ключевого слова RETURNS указывается тип TABLE без указания списка столбцов. 

Тело такой функции представляет собой единственный оператор SELECT,
который начинается сразу после ключевого слово RETURN.

Упрощенный синтаксис создания пользовательской функции INLINE имеет следующий вид:

```sql
CREATE FUNCTION <название>
(
[{<@параметр> [AS] <тип> [= <значение по умолчанию>]}]
)
RETURNS TABLE
AS
RETURN
(
SELECT
<список столбцов>
FROM
<таблица>
WHERE
<условие>
)
```

#### Функции MULTI-STATEMENT

В MULTI-STATEMENT функциях после ключевого слова RETURNS указывается тип TABLE с определением столбцов и их типов данных.
Упрощенный синтаксис создания пользовательской MULTI-STATEMENT функции имеет следующий вид:

```sql
CREATE FUNCTION <название>
(
[{<@параметр> [AS] <тип> [= <значение по умолчанию>]}]
)
RETURNS <@таблица> TABLE (<определение таблицы>)
AS
BEGIN
<команды>
RETURN
END
```
Для MULTI-STATEMENT функций оператор RETURN не имеет аргумента.
Значение возвращаемой переменной функции возвращается как значение функции.

Пример:

```sql
CREATE FUNCTION dbo.UdfGetProductsScrapStatus
(
@ScrapComLevel INT
) 
RETURNS @ResultTable TABLE
( 
ProductName VARCHAR(50), ScrapQty FLOAT, ScrapReasonDef VARCHAR(100), ScrapStatus VARCHAR(50)
) AS BEGIN
        INSERT INTO @ResultTable
            SELECT PR.Name, SUM([ScrappedQty]), SC.Name, NULL
                FROM [Production].[WorkOrder] AS WO
                        INNER JOIN 
                        Production.Product AS PR
                        ON Pr.ProductID = WO.ProductID
                        INNER JOIN Production.ScrapReason AS SC
                        ON SC.ScrapReasonID = WO.ScrapReasonID
                WHERE WO.ScrapReasonID IS NOT NULL
                GROUP BY PR.Name, SC.Name
UPDATE @ResultTable
            SET ScrapStatus = 
            CASE WHEN ScrapQty > @ScrapComLevel THEN 'Critical'
            ELSE 'Normal'
            END
        
RETURN
END
```

#### Удаление пользовательских функций

Для удаления пользовательских функций используется команда DROP FUNCTION.

Упрощенный синтаксис имеет следующий вид:

```sql
DROP FUNCTION [IF EXISTS] <название функции>
```

Ключевые слова IF EXISTS удаляют функцию только в том случае, если она уже существует.

#### Вызов пользовательских функций

Созданная функция может быть вызвана, как и обычная встроенная функция, но при этом должны вызываться с помощью имени владельца.

Простой вызов имеет следующий вид: 
```sql
SELECT <владелец>.<функция>(<параметры>)
```

Функция может быть вызвана внутри запроса для каждого значения какого-либо из столбцов.

Пример:
```sql
SELECT
<владелец>.<функция>(<столбец>) [ AS Новое название столбца]
<список других необходимых для запроса столбцов>
FROM
<таблица>
```

Для пользовательских функций допускается не более 2100 параметров. 
При выполнении функции значение каждого из объявленных параметров должно быть указано пользователем, 
если для них не определены значения по умолчанию.

Имя параметра, как и имя переменных, использует знак @ как первый символ.

Вызов функций, возвращающих табличное значение имеет вид:

```sql
SELECT * FROM <владелец>.<функция>(<параметры>)
```

Вызов функции с дефолтным значением параметра (которое было указано по умолчанию при объявлении параметров):

```sql
SELECT <владелец>.<функция>(DEFAULT) AS [Название столбца]
```

Если в функцию не передаются параметры, то при вызове в скобках ничего не указывается:

```sql
SELECT * FROM <владелец>.<функция>()
```

---
