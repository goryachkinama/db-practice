---
title: Лабораторная работа 3
---

[Таблица стран](assets/lab3/Страны.xlsx)

[К списку лабораторных >>>](../README.md)

---

### Часть 2. 12 заданий по подзапросам в таблицах со странами

1. Вывести список стран и процентное соотношение площади каждой из них к общей площади всех стран мира.
2. Вывести список стран мира, плотность населения которых больше, чем средняя плотность населения всех стран мира.
3. С помощью подзапроса вывести список европейских стран, население которых меньше 5 млн. чел.
4. Вывести список стран и процентное соотношение их площади к суммарной площади той части мира, где они находятся.
5. Вывести список стран мира, площадь которых больше, чем средняя площадь стран той части света, где они находятся.
6. Вывести список стран мира, которые находятся в тех частях света, средняя плотность населения которых превышает общемировую.
7. Вывести список южноамериканских стран, в которых живет больше людей, чем в любой африканской стране.
8. Вывести список африканских стран, в которых живет больше людей, чем хотя бы в одной южноамериканской стране.
9. Если в Африке есть хотя бы одна страна, площадь которой больше 2 млн. кв. км, вывести список всех африканских стран.
10. Вывести список стран той части света, где находится страна «Алжир».
11. Вывести список стран, население которых не превышает население страны «Алжир».
12. Вывести название страны с наибольшим населением среди стран с наименьшей  площадью на каждом континенте.

---

### [Подзапросы/вложенные запросы и их виды](https://metanit.com/sql/sqlserver/6.2.php)

В зависимости от контекста запрос SELECT может вернуть результат в одном из трех видов:

* таблица – запрос возвращает набор строк и столбцов;
* список значений – запрос возвращает значения только одного столбца, но, возможно, в нескольких строках;
* скалярное значение – запрос возвращает значение одного столбца в одной строке.

Результат запроса можно использовать в других запросах. Место использования запроса зависит от вида возвращаемого значения.

В выражении SELECT мы можем вводить подзапросы четырьмя способами:

* Использовать в условии в выражении WHERE
* Использовать в условии в выражении HAVING
* Использовать в качестве таблицы для выборки в выражении FROM
* Использовать в качестве спецификации столбца в выражении SELECT
* Использовать в команде INSERT (для определения значения)
* В команде UPDATE (после оператора SET либо как часть условия в выражении WHERE)
* В команде DELETE (часть условия)

В предложении SELECT может использоваться только скалярный подзапрос, который возвращает одно значение.

* Подзапросы пишутся в скобках.
* Подзапросы, которые используются в предложении FROM, должны иметь название для всех столбцов.
* Подзапросы, которые используются в предложении FROM, должны иметь псевдоним.
* Подзапросы, которые используются в предложении WHERE для сравнения со столбцом, должны возвращать значения соответствующего типа.
* Подзапросы, которые используются в предложении WHERE для сравнения со столбцом, должны быть вторым операндом оператора сравнения.

Каждый вложенный запрос, в свою очередь, может содержать один или более вложенный запрос. 
В инструкцию можно вложить любое количество запросов (в практике, до 32).

Подзапросы выполняются, начиная с самого глубокого.

Результат подзапроса может представлять отдельный столбец в выборке.

Пример 1: Вывести список стран и процентное соотношение их населения к суммарному населению мира:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
,ROUND(CAST(Население AS FLOAT) * 100 /
(
    SELECT SUM(Население)
    FROM Страны
), 3) AS Процент
FROM Страны
ORDER BY Процент DESC
```

---

### [Некоррелирующие и коррелирующие подзапросы](https://metanit.com/sql/sqlserver/6.1.php)

Подзапросы бывают коррелирующими и некоррелирующими. В некоррелирующих подзапросах команды выполняются один раз,
то есть результат подзапроса не зависит от строк, выбранных в основном запросе.
Такой подзапрос выполняется один раз для всего внешнего запроса.

Пример 3: С помощью подзапроса вывести список африканских стран, население которых больше 50 млн. чел.:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM (
  SELECT Название,Столица,Площадь,Население,Континент
  FROM Страны
  WHERE Континент = 'Африка') A
WHERE
Население > 50000000
```

Пример 10: Вывести список стран в той части света, где находится страна «Науру»:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Континент = (
    SELECT Континент
    FROM Страны
    WHERE Название = 'Науру'
)
```

Пример 11: Вывести список стран, население которых не превышает населении страны «Гондурас»:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Население !> (
    SELECT Население
    FROM Страны
    WHERE Название = 'Гондурас'
)
```

Также существуют коррелирующие подзапросы, результаты которых зависят от строк, выбранных в основном запросе. 
Коррелирующие подзапросы имеют связь с внешним запросом и выполняется столько раз, сколько строк в основном запросе.
Выполнение коррелирующих подзапросов сильно влияет на эффективность выполнения, т.к. они выполняются для каждой отдельной строки выборки,
поэтому их необходимо использовать только в крайних случаях.

Чтобы избежать двойственности при фильтрации в подзапросе для внешней выборки установлен один псевдоним, 
а для выборки из подзапросов - другой.

Пример 4: Вывести список стран и процентное соотношение их населения к суммарному населению к той части мира, где они находятся:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
,ROUND(CAST(Население AS FLOAT) * 100 /
(
    SELECT SUM(Население) FROM Страны Б
    WHERE А.Континент = Б.Континент
), 3) AS Процент
FROM Страны А
ORDER BY Процент DESC
```

---

### Применение конструкции IN к подзапросам

Команду IN можно применить к результатам подзапросов, возвращающих список значений.

Пример 6: Вывести список стран мира, которые находятся в тех частях света, среднее население которых больше, чем общемировое:
```sql 
SELECT Название, Столица, Площадь, Население, Континент
FROM Страны
WHERE Континент IN (
    SELECT Континент FROM Страны
    GROUP BY Континент
    HAVING AVG(Население) > (
      SELECT AVG(Население) FROM Страны
    )
)
```

---

### Конструкция ALL и [SOME | ANY](https://learn.microsoft.com/ru-ru/sql/t-sql/language-elements/some-any-transact-sql?view=sql-server-ver16)

При использовании в операторах сравнения подзапросы должны возвращать одно скалярное значение.
Но иногда возникает необходимость в предложении WHERE сравнить значение столбца со списками значений, возвращаемых подзапросом.

Чтобы при использовании в операторах сравнения подзапрос мог возвращать набор значений, 
перед ним необходимо использовать один из операторов: ALL, SOME или ANY.

При использовании оператора ALL условие в операции сравнения должно быть верно для всех значений, возвращаемых подзапросом.

Пример 7: Вывести список азиатских стран, население которых больше, чем в любой европейской стране:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Континент = 'Азия'
AND Население > ALL (
    SELECT Население
    FROM Страны
    WHERE Континент = 'Европа'
)
```

При применении ключевых слов ANY и SOME условие в операции сравнения должно быть истинным 
для хотя бы одного из значений, возвращаемых подзапросом.
По действию оба этих оператора аналогичны, поэтому можно применять любое из них.

Пример 8: Вывести список европейских стран, население которых больше, чем население хотя бы одной южноамериканской страны:
```sql 
SELECT
Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Континент = 'Европа'
AND Население > ANY (
    SELECT Население FROM Страны
    WHERE Континент = 'Южная Америка'
)
```

---

### Предикат [EXISTS](https://learn.microsoft.com/ru-ru/sql/t-sql/language-elements/exists-transact-sql?view=sql-server-ver16)

Оператор EXISTS проверяет, возвращает ли подзапрос какое-либо значение. Здесь важны не данные, а их существование.
Как правило, этот оператор используется для индикации того, что какая-либо строка удовлетворяет условию. 
То есть фактически оператор EXISTS не возвращает строки, а лишь указывает, 
что в базе данных есть как минимум одна строка, которые соответствует данному запросу. 
Поскольку возвращения набора строк не происходит, то подзапросы с подобным оператором выполняются довольно быстро.

```sql
WHERE [NOT] EXISTS (подзапрос)
```

К примеру:
```sql
SELECT * FROM Products
WHERE NOT EXISTS (SELECT * FROM Orders WHERE Products.Id = Orders.ProductId)
 ```

Стоит отметить, что для получения подобного результата мы могли бы использовать и оператор IN:

```sql
SELECT * FROM Products
WHERE Id NOT IN (SELECT ProductId FROM Orders)
```

Но поскольку при применении EXISTS не происходит выборка строк, то его использование более оптимально и эффективно, 
чем использование оператора IN.

Пример 9: Если в Африке есть хотя бы одна страна, население которой больше 100 млн. чел., 
вывести список всех африканских стран:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Континент = 'Африка'
AND EXISTS (
    SELECT * FROM Страны
    WHERE Континент = 'Африка' AND Население > 100000000
)
```

---

### Ещё примеры вложенных запросов с агрегатными функциями...

Пример 2: Вывести список стран мира, население которых больше, чем среднее население всех стран мира:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Население > (
    SELECT AVG(Население) FROM Страны)
```

Пример 5: Вывести список стран мира, население которых больше, чем среднее население стран в той части света, где они находятся:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны А
WHERE Население > (
    SELECT AVG(Население)
    FROM Страны Б
    WHERE Б.Континент = А.Континент
)
```

Пример 12: Вывести название страны с наибольшим населением среди стран с наименьшим населением на каждом континенте:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Население = (
    SELECT MAX(Мин_Нас)
    FROM
    (
        SELECT MIN(Население) AS Мин_Нас
        FROM Страны
        GROUP BY Континент
    ) A
)
```
