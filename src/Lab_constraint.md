---
Лабораторная работа. Ограничения
---

[Вариант 2](assets/lab/v2.md)

[К списку лабораторных >>>](../README.md)

---

### Задания по таблицам из демо-экзамена

Через "ALTER TABLE имя_таблицы ADD CONSTRAINT ..." добавить ограничения для столбцов, согласно ТЗ ([вариант 2](assets/lab/v2.md), примерный список):

1. Поля: идентификатор, дата добавления, дата посещения - генерируются автоматически.
2. Поля фамилии, имени и отчества не могут быть длиннее 50 символов.
3. Поле телефона может содержать только цифры и следующие символы: плюс, минус, открывающая и закрывающая круглые скобки, знак пробела.
4. Размер фотографии не должен превышать 2 мегабайта (т.е. мы работаем с PhotoPath, то ввести ограничение на длину строки с путём к файлу).
5. Попробовать задать варианты значений для именования пола в таблице с полами через команду CHECK.
6. Указать уникальность телефона и email, чтобы исключить возможность заводить клиентов с одинаковыми контактными данными
  (такое может не сработать для случая родитель-ребенок, но в большинстве других это имеет смысл).
7. Написать скрипты для добавления записей с корректными и некорректными данными. Можно реализовать обработку ошибок через try-catch.

---

### Ограничения

```sql
ALTER TABLE имя_таблицы ADD перечень_полей_с_характеристиками 
```
– позволяет добавить новые поля в таблицу;

```sql
ALTER TABLE имя_таблицы DROP COLUMN перечень_полей 
```
– позволяет удалить поля из таблицы;

```sql
ALTER TABLE имя_таблицы ADD CONSTRAINT имя_ограничения 
FOREIGN KEY(поля) REFERENCES таблица_справочник(поля) 
```
– позволяет определить связь между таблицей и таблицей справочником

Добавление свойства IDENTITY к полю 
– позволяет сделать это поле автоматически заполняемым (полем-счетчиком) для таблицы;

Все виды ограничений, которые создаются командой вида 
```sql
ALTER TABLE имя_таблицы ADD CONSTRAINT имя_ограничения
```

PRIMARY KEY – первичный ключ;
FOREIGN KEY – настройка связей и контроль ссылочной целостности данных;
UNIQUE – позволяет создать уникальность;
CHECK – позволяет осуществлять корректность введенных данных;
DEFAULT – позволяет задать значение по умолчанию;

Все ограничения можно удалить, используя команду вида
```sql
ALTER TABLE имя_таблицы DROP CONSTRAINT имя_ограничения
```
---

### Прочие ограничения (UNIQUE, DEFAULT, CHECK)

#### UNIQUE

При помощи ограничения UNIQUE можно сказать, что значения для каждой строки в данном поле или в наборе полей должно быть уникальным.

```sql
CREATE TABLE Production.TransactionHistoryArchive4  
 (  
   TransactionID int NOT NULL,   
   CONSTRAINT AK_TransactionID UNIQUE(TransactionID)   
)

ALTER TABLE Employees ADD CONSTRAINT UQ_Employees_Email UNIQUE(Email)

ALTER TABLE имя_таблицы ADD CONSTRAINT имя_ограничения UNIQUE(поле1,поле2,…)
```

#### DEFAULT

При помощи добавления к полю ограничения DEFAULT мы можем задать значение по умолчанию, 
которое будет подставляться в случае, если при вставке новой записи данное поле не будет перечислено в списке полей команды INSERT.

```sql
ALTER TABLE Employees ADD HireDate date NOT NULL DEFAULT SYSDATETIME()

ALTER TABLE Employees ADD DEFAULT SYSDATETIME() FOR HireDate

ALTER TABLE Employees ADD CONSTRAINT DF_Employees_HireDate DEFAULT SYSDATETIME() FOR HireDate
```

#### CHECK

Проверочное ограничение CHECK используется в том случае, когда необходимо осуществить проверку вставляемых в поле значений. 
Например, наложим данное ограничение на поле табельный номер, которое у нас является идентификатором сотрудника (ID). 
При помощи данного ограничения скажем, что табельные номера должны иметь значение от 1000 до 1999:

```sql
ALTER TABLE Employees ADD CONSTRAINT CK_Employees_ID CHECK(ID BETWEEN 1000 AND 1999)
```

Можно так же создать ограничения UNIQUE и CHECK без указания имени:

```sql
ALTER TABLE Employees ADD UNIQUE(Email) ALTER TABLE Employees 
ADD CHECK(ID BETWEEN 1000 AND 1999)
```

Мы можем также использовать ограничение CHECK чтобы защитить от ввода в поле определенных значений, и таким образом предотвратить ошибку. 
Например, предположим, что единствеными городами в которых мы имели ведомства сбыта являются Лондон, Барселона, Сан Хосе, и Нью Йорк. 
Если вам известны все продавцы, работающие в каждом из этих ведомств, нет необходимости позволять ввод других значений. 
Если же нет, использование ограничения может предотвратить опечатки и другие ошибки.

```sql
CREATE TABLE Salespeople
(snum integer NOT NULL UNIQUE,
sname char(10) NOT NULL UNIQUE,
city char(10)
CHECK (city IN ('London', 'New York', 'San Jose', 'Barselona')),
comm decimal CHECK (comm<1));
```

Вы можете также использовать CHECK в качестве табличного ограничения. 
Это полезно в тех случаях, когда вы хотите включить более одного поля строки в условие.
Предположим, что комиссионные .15 и выше будут разрешены только для продавца из Барселоны. 

Вы можете указать это со следующим табличным ограничением CHECK:
```sql
CREATE TABLE Salespeople
(snum integer NOT NULL UNIQUE,
sname char (10) NOT NULL UNIQUE,
city char(10),
comm decimal,
CHECK (comm < .15 OR city = 'Barcelona'))
```

#### [Просмотр списка всех ограничений](https://sky.pro/wiki/sql/sql-server-2008-kak-poluchit-ogranicheniya-vsekh-tablits/)

Просмотреть, какие ограничения созданы в отдельно взятой таблице, можно следующим запросом:

```sql
SELECT CONSTRAINT_NAME, CONSTRAINT_TYPE
FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
WHERE TABLE_NAME = 'YourTable';
```

---

### ON DELETE и ON UPDATE

Напоследок стоит сказать, что ссылочные ключи могут включать дополнительные опции 
ON DELETE CASCADE и ON UPDATE CASCADE, которые говорят о том, как вести себя при удалении или обновлении записи, 
на которую есть ссылки в таблице-справочнике. 

Если эти опции не указаны, то мы не можем изменить ID в таблице справочнике у той записи, 
на которую есть ссылки из другой таблицы, так же мы не сможем удалить такую запись из справочника, 
пока не удалим все строки, ссылающиеся на эту запись или, же обновим в этих строках ссылки на другое значение.

И для определения действия мы можем использовать следующие опции:

* NO ACTION: предотвращает какие-либо действия в зависимой таблице при удалении или изменении связанных строк в главной таблице.
  То есть фактически какие-либо действия отсутствуют.

* CASCADE: автоматически удаляет или изменяет строки из зависимой таблицы при удалении или изменении связанных строк в главной таблице.

* SET NULL: при удалении связанной строки из главной таблицы устанавливает для столбца внешнего ключа значение NULL.

* SET DEFAULT: при удалении связанной строки из главной таблицы устанавливает для столбца внешнего ключа значение по умолчанию,
  которое задается с помощью атрибуты DEFAULT. Если для столбца не задано значение по умолчанию,
  то в качестве него применяется значение NULL.

#### CASCADE

Для примера пересоздадим таблицу с указанием опции ON DELETE CASCADE для FK_Employees_DepartmentID:
```sql
DROP TABLE Employees

CREATE TABLE Employees(
  ID int NOT NULL,
  Name nvarchar(30),
  Birthday date,
  Email nvarchar(30),
  PositionID int,
  DepartmentID int,
  ManagerID int,
CONSTRAINT PK_Employees PRIMARY KEY (ID), 
CONSTRAINT FK_Employees_DepartmentID
  FOREIGN KEY(DepartmentID)
  REFERENCES Departments(ID)
  ON DELETE CASCADE, 
CONSTRAINT FK_Employees_PositionID
  FOREIGN KEY(PositionID)
  REFERENCES Positions(ID),
CONSTRAINT FK_Employees_ManagerID
  FOREIGN KEY (ManagerID)
  REFERENCES Employees(ID)
)
INSERT Employees (ID,Name,Birthday,PositionID,DepartmentID,ManagerID)VALUES
(1000,N'Иванов И.И.','19550219',2,1,NULL),
(1001,N'Петров П.П.','19831203',3,3,1003),
(1002,N'Сидоров С.С.','19760607',1,2,1000),
(1003,N'Андреев А.А.','19820417',4,3,1000)
```

Удалим отдел с идентификатором 3 из таблицы Departments:
```sql
DELETE Departments WHERE ID=3
```

Посмотрим на данные таблицы Employees:
```sql
SELECT * FROM Employees
```
Как видим, данные по отделу 3 из таблицы Employees так же удалились.

Опция ON UPDATE CASCADE ведет себя аналогично, но действует она при обновлении значения ID в справочнике (в нашем примере). 
То есть, при изменении значения первичного ключа автоматически изменится значение связанного с ним внешнего ключа. 
Но так как первичные ключи, как правило, изменяются очень редко, 
да и с принципе не рекомендуется использовать в качестве первичных ключей столбцы с изменяемыми значениями, то на практике выражение ON UPDATE используется редко.

Например, если мы поменяем ID должности в справочнике должностей, 
то в этом случае будет производиться обновление DepartmentID в таблице Employees 
на новое значение ID которое мы задали в справочнике. 

Но в данном случае это продемонстрировать просто не получится, 
т.к. у колонки ID в таблице Departments стоит опция IDENTITY, 
которая не позволит нам выполнить следующий запрос (сменить идентификатор отдела 3 на 30):
```sql
UPDATE Departments
SET ID=30
WHERE ID=3
```

Главное понять суть этих 2-х опций ON DELETE CASCADE и ON UPDATE CASCADE,
применять эти опции очень в редких случаях и хорошо подумать, 
прежде чем указывать их в ссылочном ограничении, 
т.к. при нечаянном удалении записи из таблицы справочника это может привести к большим проблемам и создать цепную реакцию.

#### Установка NULL
При установки для внешнего ключа опции SET NULL необходимо, чтобы столбец внешнего ключа допускал значение NULL:

```sql
CREATE TABLE Orders
(
    Id INT PRIMARY KEY IDENTITY,
    CustomerId INT,
    CreatedAt Date,
    FOREIGN KEY (CustomerId) REFERENCES Customers (Id) ON DELETE SET NULL
);
```

#### Установка значения по умолчанию

```sql
CREATE TABLE Orders
(
    Id INT PRIMARY KEY IDENTITY,
    CustomerId INT,
    CreatedAt Date,
    FOREIGN KEY (CustomerId) REFERENCES Customers (Id) ON DELETE SET DEFAULT
)
```

---

