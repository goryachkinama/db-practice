---
title: Лабораторная работа 3
---

[Таблица стран](assets/lab3/Страны.xlsx)

[К списку лабораторных >>>](../README.md)

---

### Часть 1. 12 заданий по фильтрации таблицы со странами

1. Вывести названия и столицы пяти наибольших стран по площади.
2. Вывести список африканских стран, население которых не превышает 1 млн. чел.
3. Вывести список стран, население которых больше 5 млн. чел., а площадь меньше
   100 тыс. кв. км, и они расположены не в Европе.
4. Вывести список стран Северной и Южной Америки, население которых больше
   20 млн. чел., или стран Африки, у которых население больше 30 млн. чел.
5. Вывести список стран, население которых составляет от 10 до 100 млн. чел., а площадь не больше 500 тыс. кв. км.
6. Вывести список стран, названия которых не начинаются с буквы «К».
7. Вывести список стран, в названии которых третья буква – «а», а предпоследняя – «и».
8. Вывести список стран, в названии которых вторая буква – гласная.
9. Вывести список стран, названия которых начинаются с букв от «К» до «П».
10. Вывести список стран, названия которых начинаются с букв от «А» до «Г», но не с буквы «Б».
11. Вывести список стран, столицы которых есть в базе.
12. Вывести список стран Африки, Северной и Южной Америки.

---

### Часть 2. 12 заданий по подзапросам в таблицах со странами

1. Вывести список стран и процентное соотношение площади каждой из них к общей площади всех стран мира.
2. Вывести список стран мира, плотность населения которых больше, чем средняя плотность населения всех стран мира.
3. С помощью подзапроса вывести список европейских стран, население которых меньше 5 млн. чел.
4. Вывести список стран и процентное соотношение их площади к суммарной площади той части мира, где они находятся.
5. Вывести список стран мира, площадь которых больше, чем средняя площадь стран той части света, где они находятся.
6. Вывести список стран мира, которые находятся в тех частях света, средняя плотность населения которых превышает общемировую.
7. Вывести список южноамериканских стран, в которых живет больше людей, чем в любой африканской стране.
8. Вывести список африканских стран, в которых живет больше людей, чем хотя бы в одной южноамериканской стране.
9. Если в Африке есть хотя бы одна страна, площадь которой больше 2 млн. кв. км, вывести список всех африканских стран.
10. Вывести список стран той части света, где находится страна «Алжир».
11. Вывести список стран, население которых не превышает население страны «Алжир».
12. Вывести название страны с наибольшим населением среди стран с наименьшей  площадью на каждом континенте.

---

### Часть 3. Задания по объединению однотипных запросов в таблицах со странами

1. Вывести объединенный результат выполнения запросов, которые выбирают страны с площадью меньше 500 кв. км и с площадью больше 5 млн. кв. км.
2. Вывести список стран с площадью больше 1 млн. кв. км, исключить страны с населением меньше 100 млн. чел.
3. Вывести список стран с площадью меньше 500 кв. км и с населением меньше 100 тыс. чел.

---

### Часть 4. Задания для своих таблиц

* !Составить 6 запросов с разными шаблонами строки для LIKE (желательно, с парой примеров на ESCAPE)
* Составить по одному запросу на UNION, UNION ALL, EXCEPT и INTERSECT
* Составить по одному запросу с подзапросом в выражении WHERE, HAVING, FROM
* !Составить по одному запросу с подзапросом в качестве спецификации столбца в выражении SELECT, в командах INSERT, UPDATE, DELETE

---

### Фильтрация данных, WHERE

Для фильтрации данных применяется оператор WHERE. Синтаксис: 

```sql
WHERE <условие>
```

В условиях поле таблицы сравнивается с константой или с выражением.
Символьные константы пишутся в одинарных кавычках.
Числовые константы и названия столбцов пишутся без кавычек.
Чтобы строка попала в результат, условие должно быть истинно.

---


### Операции сравнения

В условиях используются операции сравнения. В Transact-SQL применяются следующие операции сравнения:

* = – равенство;
* <> или != – неравенство;
* \< – меньше;
* \> – больше;
* !< – не меньше;
* !> – не больше;
* <= – меньше или равно;
* \>= – больше или равно.

При сравнении строк регистр не имеет значение. В качестве условия могут использоваться и сложные выражения.

---


### Логические операторы

Можно использовать несколько условий для фильтрации данных. Для объединения их
в одно выражение используются логические операторы. В Transact-SQL применяются следующие логические операторы:

* AND – логическое умножение или конъюнкция (И).
  Бинарный оператор, объединяет два условия; если оба условия истинны, результат – истина, иначе – ложь.
* OR – логическое сложение или дизъюнкция (ИЛИ).
  Бинарный оператор, объединяет два условия; если хотя бы одно из этих условий истинно, то общее условие оператора OR
  также будет истинно.
* NOT – логическое отрицание или инверсия (НЕ).
  Унарный оператор, применяется к одному условию. Если выражение в этой операции ложно, то общее условие истинно.

Самый высокий приоритет у оператора NOT. Самый низкий – у OR.
Если эти операторы встречаются в одном выражении, то сначала выполняется NOT, потом AND, а затем OR.

При записи условий использование скобок – хороший тон программирования.

---


### Операторы фильтрации: BETWEEN, LiKE, NULL, IN и NOT IN

Оператор BETWEEN используется для сравнения с диапазоном от начального и до конечного значения.
Начальное и конечное значения включены в промежуток.

Если надо, наоборот, выбрать те строки, которые не попадают в данный диапазон, то применяется оператор NOT BETWEEN.

```sql
WHERE выражение [NOT] BETWEEN начальное_значение AND конечное_значение
```

Пример: Вывести список стран, которые находятся в Европе и их население больше 10 млн. чел.,
или находятся в Азии, а население больше 50 млн. чел.:

```sql
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE
(Континент = 'Европа') AND (Население > 10000000)
OR
(Континент = 'Азия') AND (Население > 50000000)
```

Оператор LIKE используется для сравнения с шаблоном строки. Для определения шаблона применяются специальные символы:

* % – любая последовательность символов, в том числе пустая;
* _ – любой символ;
* \[s] – символ(ы), который указан в квадратных скобках;
* \[ - ] – символ из определенного диапазона;
* \[ ^ ] – символ, который не указан после символа ^.

```sql
WHERE выражение [NOT] LIKE шаблон_строки
```

Некоторые примеры использования подстановок:

* WHERE ProductName LIKE 'Galaxy%'
  Соответствует таким значениям как "Galaxy Ace 2" или "Galaxy S7"

* WHERE ProductName LIKE 'Galaxy S_'
  Соответствует таким значениям как "Galaxy S7" или "Galaxy S8"

* WHERE ProductName LIKE 'iPhone [78]'
  Соответствует таким значениям как "iPhone 7" или "iPhone8"

* WHERE ProductName LIKE 'iPhone [6-8]'
  Соответствует таким значениям как "iPhone 6", "iPhone 7" или "iPhone8"

* WHERE ProductName LIKE 'iPhone [^7]%'
  Соответствует таким значениям как "iPhone 6", "iPhone 6S" или "iPhone8". Но не соответствует значениям "iPhone 7" и "iPhone 7S"

* WHERE ProductName LIKE 'iPhone [^1-6]%'
  Соответствует таким значениям как "iPhone 7", "iPhone 7S" и "iPhone 8". Но не соответствует значениям "iPhone 5", "iPhone 6" и "iPhone 6S"

Пример: Вывести список стран, в названии которых вторая буква – «а», а последняя – «я»:

```sql
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Название LIKE '_а%я'
```

В базах данных, для обозначения неизвестного значения, используется понятие NULL.

Для проверки неизвестного значения нельзя использовать операторы сравнения. Допускается только IS NULL или IS NOT NULL.

```sql
SELECT * FROM Products
WHERE ProductCount IS NULL
```

Оператор IN используется для сравнения с набором значений. Список значений указывается в скобках.
Этот набор может вычисляться динамически на основании, например, еще одного запроса, либо это могут быть константные значения.

С помощью оператора NOT можно найти все строки, которые, наоборот, не соответствуют набору значений

```sql
WHERE выражение [NOT] IN (выражение)
```

Пример: Вывести список европейских, азиатских и африканских стран:

```sql
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Континент IN ('Европа', 'Азия', 'Африка')
```

---

### [ESCAPE](http://www.sql-tutorial.ru/ru/book_predicate_like.html)

При помощи ESCAPE можно задать отменяющий символ, который отменяет проверяющее действие специальных символов (_«\_»_, «%», «\[», «\]» и др).
Этот управляющий символ должен использоваться в образце перед трафаретным символом, сообщая о том, что последний следует трактовать как обычный символ.
Например, если в некотором поле следует отыскать все значения, содержащие символ _«\_»_, то шаблон ‘%_%’ приведет к тому, 
что будут возвращены все записи из таблицы. В данном случае шаблон следует записать следующим образом:

```sql
'%#_%' ESCAPE '#'
```

Для проверки значения на соответствие строке «25%» можно воспользоваться таким предикатом:

```sql
LIKE '25|%' ESCAPE '|'
```

Следует заметить, что MySQL и PostgreSQL допускают помимо ESCAPE-символа экранирование трафаретных символов 
с помощью обратного слеша (\) в стиле некоторых языков программирования общего назначения.

---

### [Подзапросы/вложенные запросы и их виды](https://metanit.com/sql/sqlserver/6.2.php)

В зависимости от контекста запрос SELECT может вернуть результат в одном из трех видов:

* таблица – запрос возвращает набор строк и столбцов;
* список значений – запрос возвращает значения только одного столбца, но, возможно, в нескольких строках;
* скалярное значение – запрос возвращает значение одного столбца в одной строке.

Результат запроса можно использовать в других запросах. Место использования запроса зависит от вида возвращаемого значения.

В выражении SELECT мы можем вводить подзапросы четырьмя способами:

* Использовать в условии в выражении WHERE
* Использовать в условии в выражении HAVING
* Использовать в качестве таблицы для выборки в выражении FROM
* Использовать в качестве спецификации столбца в выражении SELECT
* Использовать в команде INSERT (для определения значения)
* В команде UPDATE (после оператора SET либо как часть условия в выражении WHERE)
* В команде DELETE (часть условия)

В предложении SELECT может использоваться только скалярный подзапрос, который возвращает одно значение.

* Подзапросы пишутся в скобках.
* Подзапросы, которые используются в предложении FROM, должны иметь название для всех столбцов.
* Подзапросы, которые используются в предложении FROM, должны иметь псевдоним.
* Подзапросы, которые используются в предложении WHERE для сравнения со столбцом, должны возвращать значения соответствующего типа.
* Подзапросы, которые используются в предложении WHERE для сравнения со столбцом, должны быть вторым операндом оператора сравнения.

Каждый вложенный запрос, в свою очередь, может содержать один или более вложенный запрос. 
В инструкцию можно вложить любое количество запросов (в практике, до 32).

Подзапросы выполняются, начиная с самого глубокого.

Результат подзапроса может представлять отдельный столбец в выборке.

Пример 1: Вывести список стран и процентное соотношение их населения к суммарному населению мира:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
,ROUND(CAST(Население AS FLOAT) * 100 /
(
    SELECT SUM(Население)
    FROM Страны
), 3) AS Процент
FROM Страны
ORDER BY Процент DESC
```

---

### [Некоррелирующие и коррелирующие подзапросы](https://metanit.com/sql/sqlserver/6.1.php)

Подзапросы бывают коррелирующими и некоррелирующими. В некоррелирующих подзапросах команды выполняются один раз,
то есть результат подзапроса не зависит от строк, выбранных в основном запросе.
Такой подзапрос выполняется один раз для всего внешнего запроса.

Пример 3: С помощью подзапроса вывести список африканских стран, население которых больше 50 млн. чел.:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM (
  SELECT Название,Столица,Площадь,Население,Континент
  FROM Страны
  WHERE Континент = 'Африка') A
WHERE
Население > 50000000
```

Пример 10: Вывести список стран в той части света, где находится страна «Науру»:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Континент = (
    SELECT Континент
    FROM Страны
    WHERE Название = 'Науру'
)
```

Пример 11: Вывести список стран, население которых не превышает населении страны «Гондурас»:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Население !> (
    SELECT Население
    FROM Страны
    WHERE Название = 'Гондурас'
)
```

Также существуют коррелирующие подзапросы, результаты которых зависят от строк, выбранных в основном запросе. 
Коррелирующие подзапросы имеют связь с внешним запросом и выполняется столько раз, сколько строк в основном запросе.
Выполнение коррелирующих подзапросов сильно влияет на эффективность выполнения, т.к. они выполняются для каждой отдельной строки выборки,
поэтому их необходимо использовать только в крайних случаях.

Чтобы избежать двойственности при фильтрации в подзапросе для внешней выборки установлен один псевдоним, 
а для выборки из подзапросов - другой.

Пример 4: Вывести список стран и процентное соотношение их населения к суммарному населению к той части мира, где они находятся:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
,ROUND(CAST(Население AS FLOAT) * 100 /
(
    SELECT SUM(Население) FROM Страны Б
    WHERE А.Континент = Б.Континент
), 3) AS Процент
FROM Страны А
ORDER BY Процент DESC
```

---

### Применение конструкции IN к подзапросам

Команду IN можно применить к результатам подзапросов, возвращающих список значений.

Пример 6: Вывести список стран мира, которые находятся в тех частях света, среднее население которых больше, чем общемировое:
```sql 
SELECT Название, Столица, Площадь, Население, Континент
FROM Страны
WHERE Континент IN (
    SELECT Континент FROM Страны
    GROUP BY Континент
    HAVING AVG(Население) > (
      SELECT AVG(Население) FROM Страны
    )
)
```

---

### Конструкция ALL и [SOME | ANY](https://learn.microsoft.com/ru-ru/sql/t-sql/language-elements/some-any-transact-sql?view=sql-server-ver16)

При использовании в операторах сравнения подзапросы должны возвращать одно скалярное значение.
Но иногда возникает необходимость в предложении WHERE сравнить значение столбца со списками значений, возвращаемых подзапросом.

Чтобы при использовании в операторах сравнения подзапрос мог возвращать набор значений, 
перед ним необходимо использовать один из операторов: ALL, SOME или ANY.

При использовании оператора ALL условие в операции сравнения должно быть верно для всех значений, возвращаемых подзапросом.

Пример 7: Вывести список азиатских стран, население которых больше, чем в любой европейской стране:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Континент = 'Азия'
AND Население > ALL (
    SELECT Население
    FROM Страны
    WHERE Континент = 'Европа'
)
```

При применении ключевых слов ANY и SOME условие в операции сравнения должно быть истинным 
для хотя бы одного из значений, возвращаемых подзапросом.
По действию оба этих оператора аналогичны, поэтому можно применять любое из них.

Пример 8: Вывести список европейских стран, население которых больше, чем население хотя бы одной южноамериканской страны:
```sql 
SELECT
Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Континент = 'Европа'
AND Население > ANY (
    SELECT Население FROM Страны
    WHERE Континент = 'Южная Америка'
)
```

---

### Предикат [EXISTS](https://learn.microsoft.com/ru-ru/sql/t-sql/language-elements/exists-transact-sql?view=sql-server-ver16)

Оператор EXISTS проверяет, возвращает ли подзапрос какое-либо значение. Здесь важны не данные, а их существование.
Как правило, этот оператор используется для индикации того, что какая-либо строка удовлетворяет условию. 
То есть фактически оператор EXISTS не возвращает строки, а лишь указывает, 
что в базе данных есть как минимум одна строка, которые соответствует данному запросу. 
Поскольку возвращения набора строк не происходит, то подзапросы с подобным оператором выполняются довольно быстро.

```sql
WHERE [NOT] EXISTS (подзапрос)
```

К примеру:
```sql
SELECT * FROM Products
WHERE NOT EXISTS (SELECT * FROM Orders WHERE Products.Id = Orders.ProductId)
 ```

Стоит отметить, что для получения подобного результата мы могли бы использовать и оператор IN:

```sql
SELECT * FROM Products
WHERE Id NOT IN (SELECT ProductId FROM Orders)
```

Но поскольку при применении EXISTS не происходит выборка строк, то его использование более оптимально и эффективно, 
чем использование оператора IN.

Пример 9: Если в Африке есть хотя бы одна страна, население которой больше 100 млн. чел., 
вывести список всех африканских стран:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Континент = 'Африка'
AND EXISTS (
    SELECT * FROM Страны
    WHERE Континент = 'Африка' AND Население > 100000000
)
```

---

### [Объединение однотипных запросов, UNION](https://metanit.com/sql/sqlserver/7.5.php)

Для объединения результатов двух или более запросов в одну таблицу используется команда UNION.
Команда UNION объединяет вывод двух или более запросов в единый набор 
строк и столбцов и имеет вид:

```sql
SELECT_выражение1
UNION [ALL] SELECT_выражение2
[UNION [ALL] SELECT_выражениеN]
```

Для объединения результатов нескольких запросов с помощью UNION, они должны соответствовать следующим требованиям:
* содержать одинаковое количество столбцов;
* типы данных столбцов должны совпадать во всех запросах;
* в промежуточных запросах нельзя использовать сортировку ORDER BY.

Чтобы отсортировать результат объединения, в конце запроса добавляется ORDER BY.
Названия столбцов в запросах могут отличаться. Поэтому в команде ORDER BY указывается название столбцов с первого запроса.

Важно! Если объединяемые наборы содержат в строках идентичные значения, то при объединении повторяющиеся строки удаляются.

! Если необходимо при объединении сохранить повторяющиеся строки, то для этого используется параметр ALL.

Все запросы выполняются независимо друг от друга, а уже их вывод объединяется.
В объединяемых запросах можно использовать одну и ту же таблицу.

---


### [Разность двух выборок, EXCEPT](https://metanit.com/sql/sqlserver/7.6.php)

Чтобы найти разность двух выборок, то есть те строки, которые есть в первой выборке, но которых нет во второй, 
используется команда EXCEPT. Она имеет следующий вид:

```sql 
SELECT_выражение1
EXCEPT SELECT_выражение2
```

Возвращаются все различные значения, указанные слева от оператора EXCEPT.
Эти значения возвращаются, если они отсутствуют в результатах выполнения правого запроса.
Требования к использованию команды EXCEPT такие же, как к команде UNION.
Если сравниваются значения столбцов с целью определения различных строк, два значения NULL считаются равными.

---

### [Общее в двух выборках, INTERSECT](https://metanit.com/sql/sqlserver/7.7.php)

Команда INTERSECT позволяет найти общие строки в результатах двух запросов, 
то есть данный оператор выполняет операцию пересечения множеств. Команда INTERSECT имеет следующий вид:

```sql 
SELECT_выражение1
INTERSECT SELECT_выражение2
```

Требования к использованию команды INTERSECT такие же, как к командам UNION и EXCEPT.

---

### Ещё примеры вложенных запросов с агрегатными функциями...

Пример 2: Вывести список стран мира, население которых больше, чем среднее население всех стран мира:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Население > (
    SELECT AVG(Население) FROM Страны)
```

Пример 5: Вывести список стран мира, население которых больше, чем среднее население стран в той части света, где они находятся:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны А
WHERE Население > (
    SELECT AVG(Население)
    FROM Страны Б
    WHERE Б.Континент = А.Континент
)
```

Пример 12: Вывести название страны с наибольшим населением среди стран с наименьшим населением на каждом континенте:
```sql 
SELECT Название,Столица,Площадь,Население,Континент
FROM Страны
WHERE Население = (
    SELECT MAX(Мин_Нас)
    FROM
    (
        SELECT MIN(Население) AS Мин_Нас
        FROM Страны
        GROUP BY Континент
    ) A
)
```
